<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XP and Levels</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #1a1b1e;
            --card-bg: #2a2c31;
            --card-hover: #313339;
            --text-main: #ffffff;
            --text-sub: #b5bac1;
            --accent-blue: #5865f2;
            --toggle-off: #4e5058;
            --scrollbar-thumb: #111214;
            --editor-bg: #1e1f22;
            --preview-bg: #000000;
            --border: #3f4147;
        }

        /* Override Tailwind Preflight for specific elements if needed */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-size: inherit;
            font-weight: inherit;
        }

        /* Custom Dropdown Styles from Reaction_Roles */
        .dropdown-box {
            background-color: var(--editor-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-main);
        }

        .dropdown-panel {
            position: absolute;
            background-color: #111214;
            border: 1px solid #2b2d31;
            border-radius: 6px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            margin-top: 4px;
        }

        .dropdown-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-sub);
        }

        .dropdown-item:hover {
            background-color: #404249;
            color: #fff;
        }

        .custom-input {
            background-color: var(--editor-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            width: 100%;
            color: white;
            outline: none;
        }

        .custom-input:focus {
            border-color: var(--accent-blue);
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-dot.active {
            border-color: white;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Golos Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 24px 24px;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            overflow-y: overlay;
            font-size: 15px;
        }

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border: 3px solid var(--bg-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #6d6f78;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding-bottom: 100px;
            overflow: visible;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 32px;
            padding: 0;
        }

        .header-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 30px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header-description {
            font-size: 14px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-label-text {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .close-btn {
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #fff;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: var(--toggle-off);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            padding: 0 2px;
        }

        .toggle-switch.active {
            background-color: var(--accent-blue);
        }

        .toggle-switch span {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            left: 2px;
            top: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active span {
            left: 22px;
        }

        /* Section */
        .section {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-sub);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
            letter-spacing: 0.5px;
        }

        /* Slider with Range */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-input {
            width: 60px;
            height: 32px;
            background-color: var(--editor-bg);
            border: 1px solid #6d6f78;
            border-radius: 6px;
            padding: 6px 8px;
            color: var(--text-main);
            font-size: 16px;
            text-align: center;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--toggle-off) 0%, var(--accent-blue) 50%, var(--toggle-off) 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            min-width: 50px;
            text-align: right;
        }

        /* Input */
        .text-input,
        .textarea {
            background-color: var(--editor-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-main);
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            transition: border-color 0.2s;
        }

        .width-auto {
            width: auto !important;
            display: inline-block;
            min-width: 300px;
        }

        .width-limited {
            max-width: 400px;
        }

        .text-input:focus,
        .textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Small Input Frame */
        .small-input-frame {
            background-color: var(--editor-bg);
            border: 1px solid #6d6f78;
            border-radius: 6px;
            border-radius: 6px;
            padding: 10px 12px;
            display: flex;
            /* Changed from inline-flex to flex for full width */
            width: 100%;
            /* Ensure full width */
            box-sizing: border-box;
            align-items: center;
            gap: 12px;
        }

        .small-input-frame input {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 15px;
            width: 60px;
            text-align: center;
            line-height: 1;
            height: 24px;
        }

        .small-input-frame input:focus {
            outline: none;
        }

        /* Number input styling */
        input[type="number"] {
            font-variant-numeric: tabular-nums;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
            opacity: 1;
            height: 24px;
        }

        input[type="number"] {
            appearance: textfield;
        }

        .small-input-frame input[type="number"]::-webkit-outer-spin-button,
        .small-input-frame input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
            display: flex;
        }

        /* Custom spinner buttons */
        .range-input {
            position: relative;
        }

        .range-input input[type="number"]::-webkit-outer-spin-button,
        .range-input input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: inner-spin-button;
            opacity: 0.7;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab {
            padding: 8px 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-sub);
            background: none;
            border: none;
            position: relative;
            transition: color 0.2s;
        }

        .tab.active {
            color: var(--text-main);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
        }

        .tab.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Rank Card Preview (New Design) */
        .rank-card {
            background: linear-gradient(135deg, #3b2a66 0%, #9a2f62 100%);
            border-radius: 16px;
            padding: 18px 22px;
            display: flex;
            align-items: center;
            gap: 18px;
            width: 100%;
            max-width: 860px;
            min-height: 140px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 14px 24px rgba(0, 0, 0, 0.35);
        }

        .rank-card-avatar-container {
            position: relative;
        }

        .rank-card-avatar {
            width: 86px;
            height: 86px;
            border-radius: 50%;
            background-color: #2f3136;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 4px solid rgba(0, 0, 0, 0.4);
        }

        .rank-card-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 18px;
            height: 18px;
            background-color: #3ba55c;
            border-radius: 50%;
            border: 4px solid #2f3136;
        }

        .rank-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .rank-card-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-card-username {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 0.2px;
        }

        .rank-card-discriminator {
            color: #d6d6dd;
            font-size: 13px;
            opacity: 0.9;
        }

        .rank-card-stats {
            text-align: right;
            display: flex;
            align-items: baseline;
            gap: 10px;
            white-space: nowrap;
        }

        .rank-card-rank-label {
            font-size: 11px;
            color: #f0f0f3;
            letter-spacing: 0.6px;
            opacity: 0.9;
        }

        .rank-card-rank-value {
            font-size: 30px;
            font-weight: 700;
            color: #ffffff;
            margin-right: 6px;
        }

        .rank-card-level-label {
            font-size: 11px;
            color: #f0f0f3;
            letter-spacing: 0.6px;
            opacity: 0.9;
        }

        .rank-card-level-value {
            font-size: 30px;
            font-weight: 700;
            color: #ff3b75;
        }

        .rank-card-bottom-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .rank-card-xp-text {
            text-align: right;
            color: #ffffff;
            font-size: 13px;
            font-family: monospace;
            opacity: 0.9;
        }

        .rank-card-progress-track {
            background-color: #2a2c31;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rank-card-progress-fill {
            background: linear-gradient(90deg, #ff356c 0%, #ff6b6b 100%);
            height: 100%;
            width: 32%;
            border-radius: 9px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background-color: var(--editor-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-blue);
        }

        .checkbox-group label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
        }

        /* Role Rewards */
        .rewards-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reward-item {
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--editor-bg);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .reward-item input {
            width: 60px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid #6d6f78;
            border-radius: 4px;
            padding: 6px 8px;
            color: var(--text-main);
            font-size: 14px;
            text-align: center;
        }

        .reward-item select {
            flex: 1;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 8px;
            color: var(--text-main);
            font-size: 12px;
            cursor: pointer;
        }

        .reward-remove {
            background: none;
            border: none;
            color: var(--text-sub);
            cursor: pointer;
            font-size: 18px;
            transition: color 0.2s;
        }

        .reward-remove:hover {
            color: #f87171;
        }

        .btn-add {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-top: 12px;
        }

        .btn-add:hover {
            background-color: #4752c4;
        }

        /* Dropdown */
        .dropdown {
            background-color: var(--editor-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-main);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: auto;
            min-width: 250px;
            display: inline-flex;
            transition: border-color 0.2s;
        }

        .dropdown:hover {
            border-color: var(--accent-blue);
        }

        /* Multi-select Tags */
        .tag-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tag {
            background-color: var(--editor-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-remove {
            cursor: pointer;
            color: var(--text-sub);
            font-weight: 700;
        }

        .tag-remove:hover {
            color: #f87171;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            background: #2a2c31;
            border: 1px solid #3f4147;
            color: #ffffff;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 15px;
            z-index: 10000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
            max-width: 360px;
            line-height: 1.4;
        }

        .toast.error {
            border-color: #ef4444;
        }

        /* Save Bar */
        .save-bar {
            position: fixed;
            bottom: -100px;
            left: 24px;
            right: 24px;
            background-color: var(--card-bg);
            padding: 16px 24px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: bottom 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .save-bar.show {
            bottom: 24px;
        }

        .save-info {
            color: var(--text-main);
            font-size: 14px;
            font-weight: 500;
        }

        .save-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 24px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: none;
        }

        .btn-cancel {
            background-color: #4f545c;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #5d6269;
        }

        .btn-save {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-save:hover {
            background-color: #4752c4;
        }

        .indicator-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent-blue);
            border-radius: 50%;
        }

        /* Header Buttons */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-header {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid var(--border);
            background-color: var(--editor-bg);
            color: var(--text-main);
        }

        .btn-header:hover {
            background-color: var(--card-hover);
            border-color: var(--text-sub);
        }

        .btn-header-primary {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .btn-header-primary:hover {
            background-color: #4752c4;
            border-color: #4752c4;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header" style="display: block; margin-bottom: 24px;">
            <div class="header-top flex justify-between items-center" style="margin-bottom: 24px;">
                <div class="header-title-group">
                    <i data-lucide="chevron-left" class="close-btn" onclick="window.parent.closeComponent()"></i>
                    <div class="indicator-dot"></div>
                    <h1>Levels</h1>
                    <div class="header-actions ml-4">
                        <button class="btn-header" onclick="resetToDefault()">Reset to Default</button>
                        <button class="btn-header btn-header-primary" onclick="saveChanges()">Save</button>
                        <button class="btn-header" onclick="openDataManagement()">Database</button>
                    </div>
                </div>
                <div class="header-right">
                    <span class="toggle-label-text">Active</span>
                    <button class="toggle-switch" id="mainToggle" onclick="toggleMainSwitch()">
                        <span></span>
                    </button>
                </div>
            </div>

            <div class="header-bottom">
                <p class="header-description" style="margin: 0; max-width: 70%;">Give your members XP and Levels when
                    they send messages and rank them by
                    activity in a leaderboard</p>
            </div>
        </div>

        <!-- PHASE 1: XP Settings -->
        <div class="section">
            <div class="section-title">‚ö° XP Settings</div>

            <!-- XP Earning Rate -->
            <div class="form-group">
                <label class="form-label">XP Earning Rate</label>
                <div class="slider-container">
                    <input type="number" class="range-input" id="sliderMin" value="0.5" step="0.1"
                        oninput="updateSliderMin()">
                    <input type="range" class="slider" id="xpSlider" min="0.5" max="10" step="0.1" value="1.0"
                        oninput="updateSliderValue()">
                    <input type="number" class="range-input" id="sliderMax" value="10" step="0.1"
                        oninput="updateSliderMax()">
                    <span class="slider-value" id="sliderValue">1.0x</span>
                </div>
            </div>

            <!-- Formula Used -->
            <div class="form-group">
                <label class="form-label">Formula Used</label>
                <input type="text" class="text-input" value="5 * (level ^ 2) + (50 * level) + 100" readonly>
            </div>

            <!-- Message Cooldown -->
            <div class="form-group">
                <label class="form-label">Message Cooldown</label>
                <div class="small-input-frame">
                    <input type="number" id="xp_cooldown" value="60" min="1" max="3600" oninput="handleChange()">
                    <span style="color: var(--text-sub); font-size: 14px;">seconds</span>
                </div>
            </div>

            <!-- Randomized XP -->
            <div class="form-group">
                <label class="form-label">Randomized XP</label>
                <div class="small-input-frame">
                    <input type="number" id="xp_range_min" value="15" min="1" oninput="handleChange()">
                    <span style="color: var(--text-sub);">-</span>
                    <input type="number" id="xp_range_max" value="25" min="1" oninput="handleChange()">
                    <span style="color: var(--text-sub); font-size: 14px;">XP per message cooldown</span>
                </div>
            </div>
        </div>

        <!-- PHASE 2: Role Rewards -->
        <div class="section">
            <div class="section-title">üéñÔ∏è Role Rewards</div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="roleRewardsEnabled" checked onchange="handleChange()">
                    <label for="roleRewardsEnabled">Enable role rewards</label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="removePrevRole" checked onchange="handleChange()">
                    <label for="removePrevRole">Remove previous role on level up</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Add Role Rewards</label>
                <div class="rewards-list" id="rewardsList">
                    <div class="reward-item">
                        <input type="number" value="5" min="1" max="100" placeholder="Level"
                            style="font-size: 16px; width: 80px;" oninput="handleChange()">
                        <span style="color: var(--text-sub);">‚Üí</span>
                        <div class="reward-role-dropdown" style="flex: 1;">
                            <div class="dropdown"
                                style="display: flex; justify-content: space-between; align-items: center; width: auto;">
                                <span style="color: var(--text-sub); font-size: 14px;">Select role</span>
                                <span>‚ñº</span>
                            </div>
                        </div>
                        <button class="reward-remove" style="font-size: 24px;" onclick="removeReward(this)">√ó</button>
                    </div>
                </div>
                <button class="btn-add" onclick="addReward()">+ Add Reward</button>
            </div>
        </div>

        <!-- PHASE 3: Level-Up Announcements -->
        <div class="section">
            <div class="section-title">üîî Level-Up Announcements</div>

              <div class="form-group">
                  <div class="checkbox-group">
                      <input type="checkbox" id="announceEnabled" checked onchange="handleChange()">
                      <label for="announceEnabled">Send level-up announcements</label>
                  </div>
              </div>

              <div class="form-group relative">
                  <label class="form-label">Announcement Channel</label>
                  <div class="relative">
                      <div class="dropdown-box" onclick="toggleDropdown('announce_channel_dropdown')">
                          <span id="announce_channel_label" style="font-size: 14px; color: var(--text-sub);">Select channel...</span>
                          <span>‚ñº</span>
                      </div>
                      <div id="announce_channel_dropdown" class="dropdown-panel hidden">
                          <div class="p-2 text-sm text-gray-500">Loading channels...</div>
                      </div>
                  </div>
              </div>

              <!-- Tabs -->
              <div class="tabs">
                <button class="tab active" onclick="switchTab(this, 'text-msg-tab')">Text Message</button>
                <button class="tab" onclick="switchTab(this, 'rank-card-tab')">Rank Card</button>
            </div>

            <!-- Text Message Tab -->
            <div id="text-msg-tab" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Announcement Message</label>
                    <textarea class="textarea" id="announce_message" placeholder="GG {user}, you hit Level {level}!"
                        oninput="handleChange()">GG {user}, you hit Level {level}! (Rank: {ordinal})</textarea>
                </div>
            </div>

            <!-- Rank Card Tab -->
            <div id="rank-card-tab" class="tab-content">
                <div class="form-group">
                    <label class="form-label" style="margin-bottom: 12px;">Rank Card Preview</label>
                    <div class="rank-card">
                        <div class="rank-card-avatar-container">
                            <div class="rank-card-avatar">üëæ</div>
                            <div class="rank-card-status"></div>
                        </div>
                        <div class="rank-card-content">
                            <div class="rank-card-top-row">
                                <div class="rank-card-name-group">
                                    <span class="rank-card-username">MEE6 User</span>
                                    <span class="rank-card-discriminator">#1081</span>
                                </div>
                                <div class="rank-card-stats">
                                    <span class="rank-card-rank-label">RANK</span>
                                    <span class="rank-card-rank-value">#44</span>
                                    <span class="rank-card-level-label">LEVEL</span>
                                    <span class="rank-card-level-value">12</span>
                                </div>
                            </div>
                            <div class="rank-card-bottom-row">
                                <div class="rank-card-xp-text">429 / 1337 XP</div>
                                <div class="rank-card-progress-track">
                                    <div class="rank-card-progress-fill"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PHASE 4: No-XP Zones -->
        <div class="section">
            <div class="section-title">üö´ No-XP Zones</div>

            <div class="form-group relative">
                <label class="form-label">Channels</label>
                <div id="channel_selected_list" class="flex flex-wrap gap-2 mb-2"></div>
                <div class="relative">
                    <div class="dropdown-box" onclick="toggleDropdown('channel_dropdown')">
                        <span style="font-size: 14px; color: var(--text-sub);">Select channels...</span>
                        <span>‚ñº</span>
                    </div>
                    <div id="channel_dropdown" class="dropdown-panel hidden">
                        <div class="p-2 text-sm text-gray-500">Loading channels...</div>
                    </div>
                </div>
            </div>

            <div class="form-group relative">
                <label class="form-label">Roles (no XP earned)</label>
                <div id="role_selected_list" class="flex flex-wrap gap-2 mb-2"></div>

                <div class="relative">
                    <div class="dropdown-box" onclick="toggleDropdown('role_dropdown')">
                        <span id="role_dropdown_label" style="font-size: 14px; color: var(--text-sub);">Select or create
                            role...</span>
                        <span>‚ñº</span>
                    </div>

                    <div id="role_dropdown" class="dropdown-panel hidden bottom-full mb-2">
                        <div class="p-2">
                            <input id="role_search_input" type="text" class="custom-input" placeholder="Search roles..."
                                onclick="event.stopPropagation()">
                        </div>

                        <div id="role_create_entry"
                            class="p-2 rounded cursor-pointer text-sm hover:bg-[#404249] text-[#c7c9d1]">
                            + Create new role
                        </div>

                        <div id="role_create_form"
                            class="hidden mt-2 bg-[#1e1f22] border border-[#2b2d31] rounded-lg p-3">
                            <div class="config-label mb-2 text-xs font-bold text-gray-400 uppercase">Create Role</div>
                            <div class="space-y-3">
                                <input id="role_create_name" type="text" class="custom-input mb-2"
                                    placeholder="Role name" onclick="event.stopPropagation()">
                                <div>
                                    <div class="config-label mb-2 text-xs font-bold text-gray-400 uppercase">Role color
                                    </div>
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <div class="color-dot bg-[#5865f2] active" data-color="#5865f2"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#57f287]" data-color="#57f287"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#fee75c]" data-color="#fee75c"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#ed4245]" data-color="#ed4245"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#95a5a6]" data-color="#95a5a6"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#e67e22]" data-color="#e67e22"
                                            onclick="selectColor(this)"></div>
                                        <div class="color-dot bg-[#9b59b6]" data-color="#9b59b6"
                                            onclick="selectColor(this)"></div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button class="btn btn-cancel" type="button"
                                        onclick="toggleCreateForm(false, event)">Cancel</button>
                                    <button class="btn btn-save" type="button"
                                        onclick="createRole(event)">Create</button>
                                </div>
                            </div>
                        </div>

                        <div id="role_list" class="max-h-48 overflow-y-auto custom-scrollbar mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="Level/Message_Database.js"></script>
    <script>
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        let originalState = null;
        let channelsCache = [];
        let rolesCache = [];
        let selectedChannels = new Set();
        let announceChannelId = '';
        let selectedRoles = new Set();
        let createRoleColor = '#5865f2';
        let isInitialLoad = false;
        const API_BASE = window.location.origin;

        // --- Core Functions ---

        function wireCheckboxGroups() {
            document.querySelectorAll('.checkbox-group').forEach(group => {
                group.addEventListener('click', (e) => {
                    if (e.target && e.target.tagName && e.target.tagName.toLowerCase() === 'input') return;
                    const input = group.querySelector('input[type="checkbox"]');
                    if (input) {
                        input.checked = !input.checked;
                        handleChange();
                    }
                });
            });
        }

        function getFormState() {
            const state = {};

            // Global Toggle
            const toggle = document.getElementById('mainToggle');
            state.enabled = toggle ? toggle.classList.contains('active') : false;

            // XP Settings
            const slider = document.getElementById('xpSlider');
            state.xp_rate = slider ? parseFloat(slider.value) : 1.0;
            const sliderMin = document.getElementById('sliderMin');
            state.xp_rate_min = sliderMin ? parseFloat(sliderMin.value) : 0.5;
            const sliderMax = document.getElementById('sliderMax');
            state.xp_rate_max = sliderMax ? parseFloat(sliderMax.value) : 10;

            const cooldownInput = document.getElementById('xp_cooldown');
            state.cooldown = cooldownInput ? parseInt(cooldownInput.value) : 60;

            const rangeMinInput = document.getElementById('xp_range_min');
            state.xp_min = rangeMinInput ? parseInt(rangeMinInput.value) : 15;
            const rangeMaxInput = document.getElementById('xp_range_max');
            state.xp_max = rangeMaxInput ? parseInt(rangeMaxInput.value) : 25;

            // Role Rewards
            const roleRewardsToggle = document.getElementById('roleRewardsEnabled');
            state.role_rewards_enabled = roleRewardsToggle ? roleRewardsToggle.checked : true;
            const removePrevToggle = document.getElementById('removePrevRole');
            state.remove_previous_role = removePrevToggle ? removePrevToggle.checked : true;

            const rewards = [];
            rewardRows.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const levelInput = el.querySelector('input[type="number"]');
                    const roleId = el.getAttribute('data-role-id');
                    if (levelInput && roleId) {
                        rewards.push({ level: parseInt(levelInput.value), role_id: roleId });
                    }
                }
            });
            state.rewards = rewards;

            // Announcements
            const announceToggle = document.getElementById('announceEnabled');
            state.announce_enabled = announceToggle ? announceToggle.checked : true;
            const announceMsgInput = document.getElementById('announce_message');
            state.announce_message = announceMsgInput ? announceMsgInput.value : '';
            state.announce_channel_id = announceChannelId || '';

            // Active Tab
            const activeTab = document.querySelector('.tab.active');
            state.active_tab = activeTab ? activeTab.innerText.trim() : 'Text Message';

            // Zones
            state.no_xp_channels = Array.from(selectedChannels).sort();
            state.no_xp_roles = Array.from(selectedRoles).sort();

            return state;
        }

        function handleChange() {
            if (isInitialLoad) return;
            const currentState = JSON.stringify(getFormState());
            if (!originalState) originalState = currentState;

            const saveBar = document.getElementById('saveBar');
            if (saveBar) {
                if (currentState !== originalState) saveBar.classList.add('show');
                else saveBar.classList.remove('show');
            }
        }

        function toggleMainSwitch() {
            const btn = document.getElementById('mainToggle');
            if (btn) {
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    handleChange();
                    return;
                }

                const errors = validateBeforeEnable();
                if (errors.length > 0) {
                    showToast('error', `Please fix: ${errors.join('; ')}`);
                    return;
                }

                btn.classList.add('active');
                handleChange();
                saveChanges();
            }
        }

        function validateBeforeEnable() {
            const errors = [];

            const xpMin = parseFloat(document.getElementById('sliderMin')?.value);
            const xpMax = parseFloat(document.getElementById('sliderMax')?.value);
            if (Number.isNaN(xpMin) || Number.isNaN(xpMax) || xpMin <= 0 || xpMax <= 0 || xpMax < xpMin) {
                errors.push('XP earning rate min/max');
            }

            const cooldown = parseInt(document.getElementById('xp_cooldown')?.value, 10);
            if (Number.isNaN(cooldown) || cooldown < 1) {
                errors.push('Message cooldown');
            }

            const randMin = parseInt(document.getElementById('xp_range_min')?.value, 10);
            const randMax = parseInt(document.getElementById('xp_range_max')?.value, 10);
            if (Number.isNaN(randMin) || Number.isNaN(randMax) || randMin <= 0 || randMax <= 0 || randMax <= randMin) {
                errors.push('Randomized XP range');
            }

            // Role rewards: each row must have a role selected
            const rewardMissing = rewardRows.some(id => {
                const row = document.getElementById(id);
                const roleId = row ? row.getAttribute('data-role-id') : '';
                return !roleId;
            });
            if (rewardMissing) {
                errors.push('Role rewards (select role for each row)');
            }

            // Announcement channel required when enabled
            const announceEnabled = document.getElementById('announceEnabled');
            if (announceEnabled && announceEnabled.checked && !announceChannelId) {
                errors.push('Announcement channel');
            }

            return errors;
        }

        function showToast(type, message) {
            const existing = document.getElementById('levelsToast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.id = 'levelsToast';
            toast.className = `toast ${type || ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { if (toast) toast.remove(); }, 3500);
        }

        // --- Sliders & Tabs ---

        function updateSliderValue() {
            const slider = document.getElementById('xpSlider');
            if (!slider) return;
            const value = parseFloat(slider.value);
            const sliderValue = document.getElementById('sliderValue');
            if (sliderValue) sliderValue.textContent = value.toFixed(1) + 'x';
            const sliderMin = document.getElementById('sliderMin');
            const sliderMax = document.getElementById('sliderMax');
            if (sliderMin) sliderMin.value = parseFloat(slider.min);
            if (sliderMax) sliderMax.value = parseFloat(slider.max);
            handleChange();
        }

        function updateSliderMin() {
            const slider = document.getElementById('xpSlider');
            if (!slider) return;
            const min = parseFloat(document.getElementById('sliderMin').value);
            slider.min = min;
            if (parseFloat(slider.value) < min) {
                slider.value = min;
                updateSliderValue();
            }
            handleChange();
        }

        function updateSliderMax() {
            const slider = document.getElementById('xpSlider');
            if (!slider) return;
            const max = parseFloat(document.getElementById('sliderMax').value);
            slider.max = max;
            if (parseFloat(slider.value) > max) {
                slider.value = max;
                updateSliderValue();
            }
            handleChange();
        }

        function switchTab(btn, tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            const tabContent = document.getElementById(tabId);
            if (tabContent) tabContent.classList.add('active');
            handleChange();
        }

        // --- Rewards & Tags ---

        let rewardRows = [];

        function addReward(level = 5, roleId = null) {
            const list = document.getElementById('rewardsList');
            if (!list) return;

            const uniqueId = 'reward_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            const newItem = document.createElement('div');
            newItem.className = 'reward-item relative';
            newItem.id = uniqueId;
            newItem.setAttribute('data-role-id', roleId || '');
            newItem.setAttribute('data-create-color', '#5865f2');

            const role = rolesCache.find(r => String(r.id) === String(roleId));
            const roleName = role ? role.name : 'Select role';
            const roleColor = role ? '#' + (role.color || 0).toString(16).padStart(6, '0') : '';
            const dotHtml = role ? `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${roleColor}"></span>` : '';

            newItem.innerHTML = `
                <input type="number" value="${level}" min="1" max="100" placeholder="Level" style="font-size: 16px; width: 80px;" oninput="handleChange()">
                <span style="color: var(--text-sub);">‚Üí</span>
                <div class="reward-role-dropdown" style="flex: 1; position: relative;">
                    <div class="dropdown-box" onclick="toggleRewardDropdown('${uniqueId}')">
                        <span class="flex items-center" id="${uniqueId}_label">${dotHtml}${roleName}</span>
                        <span>‚ñº</span>
                    </div>
                    <div id="${uniqueId}_dropdown" class="dropdown-panel hidden absolute top-full left-0 min-w-[300px] w-full z-50 mt-1">
                         <div class="p-2">
                            <input type="text" class="custom-input" placeholder="Search roles..." oninput="filterRewardDropdown('${uniqueId}', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div id="${uniqueId}_create_entry" class="p-2 rounded cursor-pointer text-sm hover:bg-[#404249] text-[#c7c9d1]" onclick="toggleRewardCreateForm('${uniqueId}', true, event)">
                            + Create new role
                        </div>
                        <div id="${uniqueId}_create_form" class="hidden mt-2 bg-[#1e1f22] border border-[#2b2d31] rounded-lg p-3" onclick="event.stopPropagation()">
                            <div class="config-label mb-2 text-xs font-bold text-gray-400 uppercase">Create Role</div>
                            <div class="space-y-3">
                                <input id="${uniqueId}_create_name" type="text" class="custom-input mb-2" placeholder="Role name">
                                <div>
                                    <div class="config-label mb-2 text-xs font-bold text-gray-400 uppercase">Role color</div>
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <div class="color-dot bg-[#5865f2] active" data-color="#5865f2" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#57f287]" data-color="#57f287" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#fee75c]" data-color="#fee75c" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#ed4245]" data-color="#ed4245" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#95a5a6]" data-color="#95a5a6" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#e67e22]" data-color="#e67e22" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                        <div class="color-dot bg-[#9b59b6]" data-color="#9b59b6" onclick="selectRewardCreateColor('${uniqueId}', this)"></div>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button class="btn btn-cancel" type="button" onclick="toggleRewardCreateForm('${uniqueId}', false, event)">Cancel</button>
                                    <button class="btn btn-save" type="button" onclick="createRewardRole('${uniqueId}', event)">Create</button>
                                </div>
                            </div>
                        </div>
                        <div class="reward-list-container max-h-48 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
                <button class="reward-remove" style="font-size: 24px;" onclick="removeReward('${uniqueId}')">√ó</button>
            `;
            list.appendChild(newItem);
            renderRewardList(uniqueId);
            rewardRows.push(uniqueId);
            handleChange();
        }

        function toggleRewardDropdown(rowId) {
            rewardRows.forEach(id => {
                if (id !== rowId) {
                    const d = document.getElementById(id + '_dropdown');
                    if (d) d.classList.add('hidden');
                }
            });
            const el = document.getElementById(rowId + '_dropdown');
            if (el) el.classList.toggle('hidden');
        }

        function toggleRewardCreateForm(rowId, show, e) {
            if (e) e.stopPropagation();
            const form = document.getElementById(rowId + '_create_form');
            if (form) form.classList.toggle('hidden', !show);
            const entry = document.getElementById(rowId + '_create_entry');
            if (entry) entry.classList.toggle('hidden', show);
        }

        function selectRewardCreateColor(rowId, el) {
            const row = document.getElementById(rowId);
            if (row) row.setAttribute('data-create-color', el.getAttribute('data-color'));
            const container = document.getElementById(rowId + '_create_form');
            if (container) {
                container.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
            }
        }

        async function createRewardRole(rowId, e) {
            if (e) e.stopPropagation();
            const urlParams = new URLSearchParams(window.location.search);
            const guildId = urlParams.get('guild_id');
            const nameInput = document.getElementById(rowId + '_create_name');
            const name = nameInput ? nameInput.value : '';
            const row = document.getElementById(rowId);
            const color = row ? row.getAttribute('data-create-color') : '#5865f2';
            if (!name || !guildId) return;
            try {
                const resp = await fetch(`${API_BASE}/api/roles/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guild_id: guildId, name: name, color: color })
                });
                const data = await resp.json();
                if (data.success && data.role) {
                    const newRole = { id: data.role.id, name: data.role.name, color: parseInt(data.role.color.replace('#', ''), 16) };
                    rolesCache.unshift(newRole);
                    selectRewardRole(rowId, newRole);
                    renderRoleDropdown();
                    handleChange();
                } else { alert('Failed to create role: ' + (data.error || 'Unknown error')); }
            } catch (err) { console.error(err); alert('Error creating role'); }
        }

        function renderRewardList(rowId, filter = '') {
            const container = document.querySelector(`#${rowId}_dropdown .reward-list-container`);
            if (!container) return;
            container.innerHTML = '';
            const q = filter.toLowerCase();
            rolesCache.filter(r => r.name.toLowerCase().includes(q)).forEach(role => {
                const item = document.createElement('div');
                item.className = 'dropdown-item flex items-center gap-2';
                const color = '#' + (role.color || 0).toString(16).padStart(6, '0');
                item.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>${role.name}`;
                item.onclick = (e) => { e.stopPropagation(); selectRewardRole(rowId, role); };
                container.appendChild(item);
            });
        }

        function filterRewardDropdown(rowId, val) { renderRewardList(rowId, val); }

        function selectRewardRole(rowId, role) {
            const row = document.getElementById(rowId);
            if (!row) return;
            row.setAttribute('data-role-id', role.id);
            const label = document.getElementById(rowId + '_label');
            const color = '#' + (role.color || 0).toString(16).padStart(6, '0');
            if (label) { label.innerHTML = `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>${role.name}`; }
            const dropdown = document.getElementById(rowId + '_dropdown');
            if (dropdown) dropdown.classList.add('hidden');
            handleChange();
        }

        function removeReward(rowId) {
            const row = document.getElementById(rowId);
            if (row) row.remove();
            rewardRows = rewardRows.filter(id => id !== rowId);
            handleChange();
        }

        // --- Data Loading & Dropdowns ---

        async function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const guildId = urlParams.get('guild_id');
            if (!guildId) return;

            isInitialLoad = true;

            try {
                const [cResp, rResp] = await Promise.all([
                    fetch(`${API_BASE}/api/guilds/${guildId}/channels`),
                    fetch(`${API_BASE}/api/guilds/${guildId}/roles`)
                ]);
                const cData = await cResp.json();
                if (cData.success) { channelsCache = cData.channels; renderChannelDropdown(); renderAnnounceChannelDropdown(); renderAnnounceChannelLabel(); }
                const rData = await rResp.json();
                if (rData.success) { rolesCache = rData.roles.filter(r => !r.managed && r.name !== "@everyone"); renderRoleDropdown(); }
            } catch (e) { console.error("Base data load error", e); }

            try {
                const confResp = await fetch(`${API_BASE}/api/config/levels/${guildId}`);
                const confData = await confResp.json();
                if (confData.success && confData.config) {
                    const cfg = confData.config;
                    const mainToggle = document.getElementById('mainToggle');
                    if (cfg.enabled) mainToggle.classList.add('active'); else mainToggle.classList.remove('active');
                    if (cfg.xp_rate_min !== undefined) document.getElementById('sliderMin').value = cfg.xp_rate_min;
                    if (cfg.xp_rate_max !== undefined) document.getElementById('sliderMax').value = cfg.xp_rate_max;
                    const slider = document.getElementById('xpSlider');
                    slider.min = cfg.xp_rate_min || 0.5; slider.max = cfg.xp_rate_max || 10; slider.value = cfg.xp_rate || 1.0;
                    updateSliderValue();
                    if (cfg.cooldown !== undefined) document.getElementById('xp_cooldown').value = cfg.cooldown;
                    if (cfg.xp_min !== undefined) document.getElementById('xp_range_min').value = cfg.xp_min;
                    if (cfg.xp_max !== undefined) document.getElementById('xp_range_max').value = cfg.xp_max;
                    document.getElementById('roleRewardsEnabled').checked = !!cfg.role_rewards_enabled;
                    document.getElementById('removePrevRole').checked = !!cfg.remove_previous_role;
                    document.getElementById('rewardsList').innerHTML = ''; rewardRows = [];
                    if (cfg.rewards && Array.isArray(cfg.rewards)) { cfg.rewards.forEach(r => addReward(r.level, r.role_id)); }
                    document.getElementById('announceEnabled').checked = !!cfg.announce_enabled;
                    if (cfg.announce_message !== undefined) document.getElementById('announce_message').value = cfg.announce_message;
                    announceChannelId = cfg.announce_channel_id || '';
                    renderAnnounceChannelLabel();
                    if (cfg.active_tab) {
                        const tabs = document.querySelectorAll('.tab');
                        tabs.forEach(t => { if (t.innerText.trim() === cfg.active_tab) switchTab(t, cfg.active_tab === 'Text Message' ? 'text-msg-tab' : 'rank-card-tab'); });
                    }
                    selectedChannels = new Set(cfg.no_xp_channels || []); renderSelectedChannels();
                    selectedRoles = new Set(cfg.no_xp_roles || []); renderSelectedRoles();
                }
            } catch (e) { console.error("Config load error", e); }

            originalState = JSON.stringify(getFormState());
            isInitialLoad = false;
            handleChange();
        }

        function resetToDefault() {
            if (!confirm('Are you sure you want to reset all settings to default?')) return;

            isInitialLoad = true;

            // Global Toggle
            const mainToggle = document.getElementById('mainToggle');
            if (mainToggle) mainToggle.classList.remove('active');

            // XP Settings
            const sliderMin = document.getElementById('sliderMin');
            if (sliderMin) sliderMin.value = 0.5;
            const sliderMax = document.getElementById('sliderMax');
            if (sliderMax) sliderMax.value = 2.0;
            const slider = document.getElementById('xpSlider');
            if (slider) {
                slider.min = 0.5;
                slider.max = 2.0;
                slider.value = 1.0;
                updateSliderValue();
            }

            const cooldownInput = document.getElementById('xp_cooldown');
            if (cooldownInput) cooldownInput.value = 60;
            const rangeMinInput = document.getElementById('xp_range_min');
            if (rangeMinInput) rangeMinInput.value = 15;
            const rangeMaxInput = document.getElementById('xp_range_max');
            if (rangeMaxInput) rangeMaxInput.value = 25;

            // Role Rewards
            const rrEnabled = document.getElementById('roleRewardsEnabled');
            if (rrEnabled) rrEnabled.checked = true;
            const removePrev = document.getElementById('removePrevRole');
            if (removePrev) removePrev.checked = true;

            const rewardsList = document.getElementById('rewardsList');
            if (rewardsList) {
                rewardsList.innerHTML = '';
                rewardRows = [];
                addReward(5, null);
                addReward(10, null);
            }

            // Announcements
            const announceEnabled = document.getElementById('announceEnabled');
            if (announceEnabled) announceEnabled.checked = true;
            const announceMsg = document.getElementById('announce_message');
            if (announceMsg) announceMsg.value = 'GG {user}, you hit Level {level}! (Rank: {ordinal})';
            announceChannelId = '';
            renderAnnounceChannelLabel();

            // Tabs
            const firstTab = document.querySelectorAll('.tab')[0];
            if (firstTab) switchTab(firstTab, 'text-msg-tab');

            // Zones
            selectedChannels.clear();
            renderSelectedChannels();
            selectedRoles.clear();
            renderSelectedRoles();

            isInitialLoad = false;
            // originalState = JSON.stringify(getFormState()); // Don't reset originalState so save bar logic still works if desired, but user wants it gone
            handleChange();
            alert('Settings reset to default values. Don\'t forget to click Save!');
        }

        async function saveChanges() {
            const urlParams = new URLSearchParams(window.location.search);
            const guildId = urlParams.get('guild_id');
            if (!guildId) return;
            const payload = getFormState();
            try {
                const resp = await fetch(`${API_BASE}/api/config/levels/${guildId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (resp.ok) {
                    originalState = JSON.stringify(payload);
                    const saveBar = document.getElementById('saveBar');
                    if (saveBar) saveBar.classList.remove('show');
                    alert('Settings saved successfully!');
                } else { alert('Failed to save settings.'); }
            } catch (e) { console.error("Save error", e); alert('Save error'); }
        }

        function toggleDropdown(id) { const el = document.getElementById(id); if (el) el.classList.toggle('hidden'); }

        function renderChannelDropdown() {
            const list = document.getElementById('channel_dropdown'); if (!list) return; list.innerHTML = '';
            channelsCache.forEach(ch => {
                const item = document.createElement('div'); item.className = 'dropdown-item'; item.innerHTML = `<span style="margin-right:8px">#</span>${ch.name}`;
                item.onclick = () => { if (selectedChannels.has(ch.id)) selectedChannels.delete(ch.id); else selectedChannels.add(ch.id); renderSelectedChannels(); toggleDropdown('channel_dropdown'); handleChange(); };
                list.appendChild(item);
            });
        }

        function renderAnnounceChannelDropdown() {
            const list = document.getElementById('announce_channel_dropdown'); if (!list) return; list.innerHTML = '';
            channelsCache.forEach(ch => {
                const item = document.createElement('div'); item.className = 'dropdown-item'; item.innerHTML = `<span style="margin-right:8px">#</span>${ch.name}`;
                item.onclick = () => { announceChannelId = ch.id; renderAnnounceChannelLabel(); toggleDropdown('announce_channel_dropdown'); handleChange(); };
                list.appendChild(item);
            });
        }

        function renderAnnounceChannelLabel() {
            const label = document.getElementById('announce_channel_label'); if (!label) return;
            const ch = channelsCache.find(c => String(c.id) === String(announceChannelId));
            label.textContent = ch ? `#${ch.name}` : 'Select channel...';
            label.style.color = ch ? 'var(--text)' : 'var(--text-sub)';
        }

        function renderSelectedChannels() {
            const container = document.getElementById('channel_selected_list'); if (!container) return; container.innerHTML = '';
            selectedChannels.forEach(id => {
                const ch = channelsCache.find(c => c.id === id); if (!ch) return;
                const tag = document.createElement('div'); tag.className = 'tag'; tag.innerHTML = `<span style="font-size:14px; margin-right:4px; color:#b5bac1">#</span>${ch.name}<span class="tag-remove" style="margin-left:6px" onclick="removeChannel('${id}')">√ó</span>`;
                container.appendChild(tag);
            });
        }

        window.removeChannel = function (id) { selectedChannels.delete(id); renderSelectedChannels(); handleChange(); }

        function renderRoleDropdown(filter = '') {
            const list = document.getElementById('role_list'); if (!list) return; list.innerHTML = '';
            const q = filter.toLowerCase();
            rolesCache.filter(r => r.name.toLowerCase().includes(q)).forEach(role => {
                const item = document.createElement('div'); item.className = 'dropdown-item flex items-center gap-2';
                item.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${'#' + (role.color || 0).toString(16).padStart(6, '0')}"></span>${role.name}`;
                item.onclick = () => { selectedRoles.add(role.id); renderSelectedRoles(); toggleDropdown('role_dropdown'); handleChange(); };
                list.appendChild(item);
            });
        }

        function renderSelectedRoles() {
            const container = document.getElementById('role_selected_list'); if (!container) return; container.innerHTML = '';
            selectedRoles.forEach(id => {
                const role = rolesCache.find(r => r.id === id); if (!role) return;
                const color = '#' + (role.color || 0).toString(16).padStart(6, '0');
                const tag = document.createElement('div'); tag.className = 'tag'; tag.style.borderLeft = `4px solid ${color}`;
                tag.innerHTML = `<span style="width: 8px; height: 8px; background-color: ${color}; border-radius: 50%; display: inline-block; margin-right: 6px;"></span>${role.name}<span class="tag-remove" style="font-size: 16px; margin-left: 6px;" onclick="removeRole('${id}')">√ó</span>`;
                container.appendChild(tag);
            });
        }

        window.removeRole = function (id) { selectedRoles.delete(id); renderSelectedRoles(); handleChange(); }

        window.toggleCreateForm = function (show, e) { if (e) e.stopPropagation(); const form = document.getElementById('role_create_form'); if (form) form.classList.toggle('hidden', !show); const entry = document.getElementById('role_create_entry'); if (entry) entry.classList.toggle('hidden', show); }

        window.selectColor = function (el) { createRoleColor = el.getAttribute('data-color'); document.querySelectorAll('#role_create_form .color-dot').forEach(d => d.classList.remove('active')); el.classList.add('active'); }

        window.createRole = async function (e) {
            if (e) e.stopPropagation(); const urlParams = new URLSearchParams(window.location.search); const guildId = urlParams.get('guild_id'); const name = document.getElementById('role_create_name').value; if (!name || !guildId) return;
            try {
                const resp = await fetch(`${API_BASE}/api/roles/create`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ guild_id: guildId, name: name, color: createRoleColor }) });
                const data = await resp.json();
                if (data.success && data.role) {
                    const newRole = { id: data.role.id, name: data.role.name, color: parseInt(data.role.color.replace('#', ''), 16) };
                    rolesCache.unshift(newRole); selectedRoles.add(newRole.id); renderSelectedRoles(); renderRoleDropdown(); toggleCreateForm(false); handleChange();
                } else { alert('Failed to create role: ' + (data.error || 'Unknown error')); }
            } catch (err) { console.error(err); alert('Error creating role'); }
        }

        const searchInput = document.getElementById('role_search_input'); if (searchInput) { searchInput.addEventListener('input', (e) => renderRoleDropdown(e.target.value)); searchInput.addEventListener('click', (e) => e.stopPropagation()); }
        const createEntry = document.getElementById('role_create_entry'); if (createEntry) createEntry.addEventListener('click', (e) => { e.stopPropagation(); toggleCreateForm(true); });

        function cancelChanges() { location.reload(); }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', function () { updateSliderValue(); wireCheckboxGroups(); loadData(); }); } else { updateSliderValue(); wireCheckboxGroups(); loadData(); }
    </script>
</body>

</html>
