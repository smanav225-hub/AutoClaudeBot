<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome & Goodbye Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@400;700&family=Poppins:wght@400;700&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Raleway:wght@400;700&family=Open+Sans:wght@400;700&family=Merriweather:wght@400;700&family=Oswald:wght@400;700&family=Ubuntu:wght@400;700&family=Playfair+Display:wght@400;700&family=Nunito:wght@400;700&family=Bebas+Neue&family=Quicksand:wght@400;700&family=Fira+Sans:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #1a1b1e;
            --card-bg: #2a2c31;
            --card-hover: #313339;
            --text-main: #ffffff;
            --text-sub: #b5bac1;
            --accent-blue: #5865f2;
            /* Discord/MEE6 Blue */
            --accent-green: #23a559;
            --toggle-off: #4e5058;
            --scrollbar-thumb: #111214;
            --editor-bg: #1e1f22;
            --preview-bg: #000000;
            --border: #3f4147;
        }

        body {
            font-family: 'Golos Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 30px;
            display: flex;
            justify-content: center;
            outline: none !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border: 3px solid var(--bg-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #6d6f78;
        }

        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding-bottom: 100px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            padding: 0 4px;
        }

        .header-info h1 {
            font-size: 26px;
            font-weight: 700;
            margin: 0 0 10px 0;
            letter-spacing: -0.5px;
        }

        .header-info p {
            color: var(--text-sub);
            font-size: 15px;
            margin: 0;
            max-width: 540px;
            line-height: 1.6;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-blue);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Feature Cards */
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feature-card-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .feature-card-container.allow-overflow {
            overflow: visible;
        }

        .feature-card-header {
            padding: 22px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .feature-card-header:hover {
            background-color: var(--card-hover);
        }

        .feature-title {
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .badge-new {
            background-color: #23a559;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 5px;
            text-transform: uppercase;
        }

        /* Expandable Section */
        .expandable-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background-color: #232529;
        }

        .expandable-section.active {
            max-height: 1500px;
            transition: max-height 0.4s cubic-bezier(1, 0, 1, 0);
        }

        .expandable-section.allow-overflow {
            overflow: visible;
        }

        .config-content {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: var(--editor-bg);
            border-radius: 8px;
            width: fit-content;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-sub);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab.active {
            color: #fff;
            background-color: #404249;
        }

        .tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Color Dot */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }

        .color-dot:hover {
            transform: scale(1.2);
        }

        .color-dot.active {
            border-color: white;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .color-dot.active::after {
            content: '';
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }

        /* Embed Border */
        .embed-stripe {
            border-left: 4px solid var(--accent-blue);
            padding-left: 16px;
        }

        /* Image Placeholder */
        .img-upload {
            width: 48px;
            height: 48px;
            background: #1e1f22;
            border: 1px dashed #4e5058;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #b5bac1;
        }

        .img-upload:hover {
            background: #2b2d31;
            border-color: #b5bac1;
        }

        .img-upload-lg {
            width: 64px;
            height: 64px;
        }

        /* Editor */
        .config-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-sub);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .dropdown-box {
            background-color: var(--editor-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }

        .text-editor-container {
            position: relative;
        }

        .text-editor {
            width: 100%;
            height: 120px;
            background-color: var(--editor-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 14px;
            resize: none;
        }

        .char-counter {
            position: absolute;
            bottom: 10px;
            right: 12px;
            font-size: 11px;
            color: #555;
        }

        /* Preview Card */
        .preview-card {
            background-color: var(--preview-bg);
            border-radius: 12px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border: 1px solid #222;
        }

        .avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            overflow: hidden;
            background-color: #333;
            display: flex;
            items-center;
            justify-center;
        }

        .preview-text {
            font-size: 15px;
            color: white;
            text-align: center;
            line-height: 1.4;
        }

        .member-rank {
            font-size: 12px;
            color: var(--text-sub);
        }

        /* Save Bar */
        .save-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 60px);
            max-width: 800px;
            background-color: #111214;
            padding: 15px 25px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: bottom 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .save-bar.active {
            bottom: 25px;
        }

        .save-info {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .save-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: none;
        }

        .btn-cancel {
            background-color: #4f545c;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #5d6269;
        }

        .btn-save {
            background-color: #5865f2;
            color: white;
        }

        .btn-save:hover {
            background-color: #4752c4;
        }

        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #3f4147;
            border-radius: 5px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .premium-badge {
            background: #313339;
            color: #f1c40f;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(241, 196, 15, 0.2);
        }

        .welcome-card-preview {
            width: 100%;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background-color: #000;
            background-size: cover;
            background-position: center;
            transition: all 0.3s;
        }

        .card-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
        }

        .card-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            text-align: center;
        }

        .card-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #fff;
            overflow: hidden;
        }

        .card-title {
            font-size: 30px;
            font-weight: 700;
            color: #fff;
        }

        .card-subtitle {
            font-size: 20px;
            font-weight: 600;
            color: #aaa;
        }

        .custom-input {
            width: 100%;
            background-color: var(--editor-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .command-badge {
            background-color: #313339;
            color: #b5bac1;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #3f4147;
            transition: 0.2s;
            user-select: none;
        }

        .command-badge:hover {
            background-color: #404249;
            color: #fff;
            border-color: var(--accent-blue);
        }

        .card-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.02);
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .card-toggle-label {
            font-size: 15px;
            font-weight: 600;
        }

        .unified-preview {
            background-color: var(--preview-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #222;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-info">
                <h1>Welcome & Goodbye</h1>
                <p>Automatically send messages and give roles to your new members and send a message when a members
                    leaves your server</p>
            </div>
            <div class="main-toggle-container"></div>
        </div>

        <div class="feature-list">
            <!-- Feature 1 -->
            <!-- Feature 2 (The Detailed One) -->
            <div class="feature-card-container">
                <div class="feature-card-header" onclick="toggleSection(this)">
                    <div class="feature-title">Send a message when a user joins the server</div>
                    <label class="switch">
                        <input type="checkbox" id="toggle_join" onchange="handleToggle(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="join-server-container"></div>
            </div>

            <!-- Other features (simplified placeholders for this demo) -->
                    <div class="feature-card-container">
                        <div class="feature-card-header" onclick="toggleSection(this)">
                            <div class="feature-title">Send a private message to new users</div>
                            <label class="switch">
                                <input type="checkbox" id="toggle_dm" onchange="handleToggle(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="join-private-container"></div>
                    </div>

                    <div class="feature-card-container allow-overflow">
                        <div class="feature-card-header" onclick="toggleSection(this)">
                            <div class="feature-title">Give a role to new users</div>
                            <label class="switch">
                                <input type="checkbox" id="toggle_role" onchange="handleToggle(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="join-role-container"></div>
                    </div>

                    <div class="feature-card-container">
                        <div class="feature-card-header" onclick="toggleSection(this)">
                            <div class="feature-title">Send a message when a user leaves the server</div>
                            <label class="switch">
                                <input type="checkbox" id="toggle_leave" onchange="handleToggle(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="leave-server-container"></div>
                    </div>
                </div>
            </div>

            <!-- Save Changes Bar -->
            <div id="saveBar" class="save-bar">
                <div class="save-info">Changes detected! Please save or cancel.</div>
                <div class="save-actions">
                    <button class="btn btn-cancel" onclick="cancelChanges()">Cancel</button>
                    <button class="btn btn-save" onclick="saveChanges()">Save</button>
                </div>
            </div>

            <script>
                const API_BASE = window.location.origin;
                lucide.createIcons();

                let state = {
                    join: {
                        enabled: false,
                        channel: 'general',
                        type: 'text',
                        text: 'Hey {user}, welcome to **{server}**!',
                        card: {
                            enabled: false,
                            font: 'Inter',
                            textColor: '#ffffff',
                            bgColor: '#000000',
                            bgImage: '',
                            opacity: 50,
                            title: '{user.idname} just joined the server',
                            subtitle: 'Member # {server.member_count}'
                        },
                        embed: {
                            color: '#6b7280',
                            author: '',
                            title: '',
                            description: 'Hey {user}, welcome to **{server}**!',
                            footer: ''
                        }
                    },
                    dm: {
                        enabled: false,
                        type: 'text',
                        text: 'Hey {user}, welcome to **{server}**!',
                        card: {
                            enabled: false,
                            font: 'Inter',
                            textColor: '#ffffff',
                            bgColor: '#000000',
                            bgImage: '',
                            opacity: 50,
                            title: '{user.idname} just joined the server',
                            subtitle: 'Member # {server.member_count}'
                        },
                        embed: {
                            color: '#6b7280',
                            author: '',
                            title: '',
                            description: 'Hey {user}, welcome to **{server}**!',
                            footer: ''
                        }
                    },
                    role: {
                        enabled: false,
                        selected_roles: []
                    },
                    leave: {
                        enabled: false,
                        channel: 'general',
                        type: 'text',
                        text: '{user} just left the server.'
                    }
                };

                let initialState = JSON.parse(JSON.stringify(state));

                function toggleSection(header) {
                    const container = header.parentElement;
                    const section = container.querySelector('.expandable-section');
                    const toggle = header.querySelector('input[type="checkbox"]');

                    if (toggle && toggle.checked) {
                        if (section) section.classList.toggle('active');
                    }
                }

                async function handleToggle(checkbox) {
                    const key = checkbox.id.replace('toggle_', '');
                    
                    // Update global state
                    if (state[key] !== undefined) {
                        if (typeof state[key] === 'object') state[key].enabled = checkbox.checked;
                        else state[key] = checkbox.checked;
                    }

                    // Lazy Load Logic for Join
                    if (key === 'join') {
                        window.__userToggledJoin = true;
                        const container = document.getElementById('join-server-container');
                        if (checkbox.checked) {
                            // Show loading state
                            container.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Loading settings...</div>';
                            
                            // Helper to initialize after script load
                            const initJoin = () => {
                                if (window.JOIN_SERVER_HTML && window.initializeJoinServer) {
                                    container.innerHTML = window.JOIN_SERVER_HTML;
                                    window.initializeJoinServer();
                                    // Expand the section
                                    setTimeout(() => {
                                        const section = container.querySelector('.expandable-section');
                                        if (section) section.classList.add('active');
                                    }, 50);
                                } else {
                                    container.innerHTML = '<div class="p-4 text-center text-sm text-red-500">Failed to initialize Join Server component.</div>';
                                }
                            };

                            // Check if script is already loaded
                            if (window.initializeJoinServer && window.JOIN_SERVER_HTML) {
                                initJoin();
                                return;
                            }

                            // Load the JS component dynamically
                            const script = document.createElement('script');
                            script.src = 'Welcome_Goodbye/Join_Server.js';
                            script.onload = initJoin;
                            script.onerror = () => {
                                container.innerHTML = `<div class="p-4 text-center text-sm text-red-500">
                                    Error loading script: Welcome_Goodbye/Join_Server.js<br>
                                    <span class="text-xs text-gray-400">Ensure the file exists in the same directory.</span>
                                </div>`;
                            };
                            document.body.appendChild(script);

                        } else {
                            container.innerHTML = '';
                        }
                    } else if (key === 'leave') {
                        window.__userToggledLeave = true;
                        const container = document.getElementById('leave-server-container');
                        if (checkbox.checked) {
                            // Show loading state
                            container.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Loading settings...</div>';
                            
                            // Helper to initialize after script load
                            const initLeave = () => {
                                if (window.LEAVE_SERVER_HTML && window.initializeLeaveServer) {
                                    container.innerHTML = window.LEAVE_SERVER_HTML;
                                    window.initializeLeaveServer();
                                    // Expand the section
                                    setTimeout(() => {
                                        const section = container.querySelector('.expandable-section');
                                        if (section) section.classList.add('active');
                                    }, 50);
                                } else {
                                    container.innerHTML = '<div class="p-4 text-center text-sm text-red-500">Failed to initialize Leave Server component.</div>';
                                }
                            };

                            // Check if script is already loaded
                            if (window.initializeLeaveServer && window.LEAVE_SERVER_HTML) {
                                initLeave();
                                return;
                            }

                            // Load the JS component dynamically
                            const script = document.createElement('script');
                            script.src = 'Welcome_Goodbye/Leave_Server.js';
                            script.onload = initLeave;
                            script.onerror = () => {
                                container.innerHTML = `<div class="p-4 text-center text-sm text-red-500">
                                    Error loading script: Welcome_Goodbye/Leave_Server.js
                                </div>`;
                            };
                            document.body.appendChild(script);

                        } else {
                            container.innerHTML = '';
                        }
                    } else if (key === 'dm') {
                        window.__userToggledDm = true;
                        const container = document.getElementById('join-private-container');
                        if (checkbox.checked) {
                            container.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Loading settings...</div>';

                            const initDm = () => {
                                if (window.JOIN_PRIVATE_HTML && window.initializeJoinPrivateMessage) {
                                    container.innerHTML = window.JOIN_PRIVATE_HTML;
                                    window.initializeJoinPrivateMessage();
                                    setTimeout(() => {
                                        const section = container.querySelector('.expandable-section');
                                        if (section) section.classList.add('active');
                                    }, 50);
                                } else {
                                    container.innerHTML = '<div class="p-4 text-center text-sm text-red-500">Failed to initialize Join Private Message component.</div>';
                                }
                            };

                            if (window.initializeJoinPrivateMessage && window.JOIN_PRIVATE_HTML) {
                                initDm();
                                return;
                            }

                            const script = document.createElement('script');
                            script.src = 'Welcome_Goodbye/Join_Private_message.js';
                            script.onload = initDm;
                            script.onerror = () => {
                                container.innerHTML = `<div class="p-4 text-center text-sm text-red-500">
                                    Error loading script: Welcome_Goodbye/Join_Private_message.js<br>
                                    <span class="text-xs text-gray-400">Ensure the file exists in the same directory.</span>
                                </div>`;
                            };
                            document.body.appendChild(script);
                        } else {
                            container.innerHTML = '';
                        }
                    } else if (key === 'role') {
                        window.__userToggledRole = true;
                        const container = document.getElementById('join-role-container');
                        if (checkbox.checked) {
                            container.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Loading settings...</div>';

                            const initRole = () => {
                                if (window.JOIN_ROLE_HTML && window.initializeJoinRole) {
                                    container.innerHTML = window.JOIN_ROLE_HTML;
                                    window.initializeJoinRole();
                                    setTimeout(() => {
                                        const section = container.querySelector('.expandable-section');
                                        if (section) section.classList.add('active');
                                    }, 50);
                                } else {
                                    container.innerHTML = '<div class="p-4 text-center text-sm text-red-500">Failed to initialize Join Role component.</div>';
                                }
                            };

                            if (window.initializeJoinRole && window.JOIN_ROLE_HTML) {
                                initRole();
                                return;
                            }

                            const script = document.createElement('script');
                            script.src = 'Welcome_Goodbye/Join_Role.js';
                            script.onload = initRole;
                            script.onerror = () => {
                                container.innerHTML = `<div class="p-4 text-center text-sm text-red-500">
                                    Error loading script: Welcome_Goodbye/Join_Role.js<br>
                                    <span class="text-xs text-gray-400">Ensure the file exists in the same directory.</span>
                                </div>`;
                            };
                            document.body.appendChild(script);
                        } else {
                            container.innerHTML = '';
                        }
                    } else {
                        // Standard behavior for other features
                        const container = checkbox.closest('.feature-card-container');
                        const section = container.querySelector('.expandable-section');
                        if (section) {
                            if (checkbox.checked) {
                                section.classList.add('active');
                            } else {
                                section.classList.remove('active');
                            }
                        }
                    }
                    checkForChanges();
                }

                function handleChanges() {
                    checkForChanges();
                }

                function checkForChanges() {
                    const isChanged = JSON.stringify(state) !== JSON.stringify(initialState);
                    const bar = document.getElementById('saveBar');
                    if (isChanged) bar.classList.add('active');
                    else bar.classList.remove('active');
                }

                function cancelChanges() {
                    state = JSON.parse(JSON.stringify(initialState));
                    location.reload();
                }

                async function saveChanges() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const guildId = urlParams.get('guild_id');
                    if (!guildId) return;

                    try {
                        // Unified save logic: persist both features currently in state
                        const jPromise = fetch(`/api/config/join/${guildId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(state.join)
                        });
                        
                        const lPromise = fetch(`/api/config/leave/${guildId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(state.leave)
                        });

                        const dPromise = fetch(`/api/config/dm/${guildId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(state.dm)
                        });

                        const rPromise = fetch(`/api/config/role/${guildId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(state.role)
                        });

                        const results = await Promise.all([jPromise, lPromise, dPromise, rPromise]);
                        
                        if (results.every(r => r.ok)) {
                            initialState = JSON.parse(JSON.stringify(state));
                            checkForChanges();
                            alert("Settings saved successfully!");
                        } else {
                            alert("One or more settings failed to save.");
                        }
                    } catch (e) {
                        console.error("Save failed", e);
                        alert("An error occurred while saving.");
                    }
                }

                function rgbToHex(rgb) {
                    if (!rgb) return "";
                    if (rgb.startsWith('#')) return rgb;
                    const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                    if (!match) return rgb;
                    function hex(x) { return ("0" + parseInt(x).toString(16)).slice(-2); }
                    return "#" + hex(match[1]) + hex(match[2]) + hex(match[3]);
                }

                // === Auto-Load & Expand Logic ===
                async function loadSavedSettings() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const guildId = urlParams.get('guild_id');
                    if (!guildId) return;

                    // Fetch Join Config
                    try {
                        const jResp = await fetch(`/api/config/join/${guildId}`);
                        const jData = await jResp.json();
                        if (jData.success && jData.config && jData.config.enabled) {
                            state.join = { ...state.join, ...jData.config };
                            const toggle = document.getElementById('toggle_join');
                            if (toggle) {
                                toggle.checked = true;
                                await handleToggle(toggle);
                            }
                        }
                    } catch(e) { console.error("Error loading join config", e); }

                    // Fetch Leave Config
                    try {
                        const lResp = await fetch(`/api/config/leave/${guildId}`);
                        const lData = await lResp.json();
                        if (lData.success && lData.config && lData.config.enabled) {
                            state.leave = { ...state.leave, ...lData.config };
                            const toggle = document.getElementById('toggle_leave');
                            if (toggle) {
                                toggle.checked = true;
                                await handleToggle(toggle);
                            }
                        }
                    } catch(e) { console.error("Error loading leave config", e); }

                    // Fetch DM Config
                    try {
                        const dResp = await fetch(`/api/config/dm/${guildId}`);
                        const dData = await dResp.json();
                        if (dData.success && dData.config && dData.config.enabled) {
                            state.dm = { ...state.dm, ...dData.config };
                            const toggle = document.getElementById('toggle_dm');
                            if (toggle) {
                                toggle.checked = true;
                                await handleToggle(toggle);
                            }
                        }
                    } catch(e) { console.error("Error loading dm config", e); }

                    // Fetch Role Config
                    try {
                        const rResp = await fetch(`/api/config/role/${guildId}`);
                        const rData = await rResp.json();
                        if (rData.success && rData.config) {
                            state.role = { ...state.role, ...rData.config };
                            const toggle = document.getElementById('toggle_role');
                            if (toggle) {
                                toggle.checked = !!rData.config.enabled;
                                if (toggle.checked) {
                                    await handleToggle(toggle);
                                }
                            }
                        }
                    } catch(e) { console.error("Error loading role config", e); }
                    
                    // Final sync of initialState to match loaded data
                    initialState = JSON.parse(JSON.stringify(state));
                    checkForChanges();
                }

                // Execute startup logic
                loadSavedSettings();

            </script>
</body>

</html>


